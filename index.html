<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>رهبان - انتخاب مطمئن برای تصمیم های مهم</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@300;400;500;600;700;800&display.swap" rel="stylesheet">
    
    <!-- Ionicons for Icons (from ghararban.html) -->
    <script type="module" src="https://unpkg.com/ionicons@5.5.2/dist/ionicons/ionicons.esm.js"></script>
    <script nomodule src="https://unpkg.com/ionicons@5.5.2/dist/ionicons/ionicons.js"></script>
    
    <style>
        body {
            font-family: 'Vazirmatn', sans-serif;
            scroll-behavior: smooth;
            background-color: #f7fafc;
        }
        :root {
            --primary-color: #151450;
            --accent-color: #F06F11;
        }
        .primary-color { color: var(--primary-color); }
        .bg-primary-color { background-color: var(--primary-color); }
        .hover-bg-primary-color:hover { background-color: #0d0c3a; }
        .accent-color { color: var(--accent-color); }
        .bg-accent-color { background-color: var(--accent-color); }
        .hover-bg-accent-color:hover { background-color: #d8630c; }
        
        .service-card {
            background-color: #ffffff;
            border-radius: 1.25rem;
            padding: 2rem;
            border: 1px solid #e2e8f0;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            display: flex;
            flex-direction: column;
        }
        .service-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1);
        }
        
        /* Styles for Qararban Modal (Integrated) */
        .qararban-container {
            backdrop-filter: blur(4px);
        }
        .tab-active {
            border-color: var(--accent-color);
            color: var(--accent-color);
            background-color: white;
            font-weight: 700;
        }
        .tab-pane { display: none; }
        .tab-pane.active { display: block; }
        
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid var(--primary-color);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        #notification {
            transition: transform 0.5s ease-in-out, opacity 0.5s ease-in-out;
            transform: translateX(100%);
            opacity: 0;
        }
        #notification.show {
            transform: translateX(0);
            opacity: 1;
        }

        #fab-google-form {
            transition: opacity 0.3s, transform 0.3s;
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-900">

    <!-- Notification Element for Qararban -->
    <div id="notification" class="fixed top-8 right-8 z-[101] p-4 rounded-lg shadow-xl text-white max-w-sm">
        <p id="notification-message"></p>
    </div>

    <header class="bg-white/80 backdrop-blur-sm sticky top-0 z-50 shadow-sm">
        <nav class="container mx-auto px-6 py-4 flex justify-between items-center">
            <div class="font-extrabold text-2xl primary-color" data-key="brand_name">رهبان</div>
            <div class="hidden md:flex items-center space-x-8 space-x-reverse">
                <a href="#services" class="text-gray-600 hover:text-[#151450] font-semibold">خدمات</a>
                <a href="#calculator" class="text-gray-600 hover:text-[#151450] font-semibold">ماشین حساب گمرکی</a>
                <a href="#why-outsource" class="text-gray-600 hover:text-[#151450] font-semibold">چرا برون‌سپاری؟</a>
                <a href="#process" class="text-gray-600 hover:text-[#151450] font-semibold">فرآیند کار</a>
                <a href="#contact" class="text-gray-600 hover:text-[#151450] font-semibold">تماس با ما</a>
                <button data-action="open-qararban" class="bg-primary-color hover-bg-primary-color text-white font-bold py-2 px-5 rounded-lg transition-colors">✨ قراربان</button>
            </div>
            <button id="menu-btn" class="md:hidden primary-color">
                <svg class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7"></path></svg>
            </button>
        </nav>
        <div id="mobile-menu" class="hidden md:hidden px-6 pt-2 pb-4 border-t">
             <a href="#services" class="block py-2 text-gray-600 font-semibold">خدمات</a>
             <a href="#calculator" class="block py-2 text-gray-600 font-semibold">ماشین حساب گمرکی</a>
             <a href="#why-outsource" class="block py-2 text-gray-600 font-semibold">چرا برون‌سپاری؟</a>
             <a href="#process" class="block py-2 text-gray-600 font-semibold">فرآیند کار</a>
             <a href="#contact" class="block py-2 text-gray-600 font-semibold">تماس با ما</a>
             <button data-action="open-qararban" class="w-full block py-2 font-semibold bg-primary-color text-white text-center mt-2 rounded-lg">✨ قراربان</button>
        </div>
    </header>

    <main>
        <!-- All other sections of the main page remain the same -->
        <section id="hero" class="bg-primary-color min-h-screen flex items-center justify-center">
            <div class="container mx-auto px-6 py-24 text-center">
                <h1 class="text-4xl md:text-5xl lg:text-6xl font-extrabold text-white mb-4">انتخاب مطمئن برای تصمیم‌های مهم</h1>
                <p class="text-lg md:text-xl text-gray-300 max-w-4xl mx-auto mb-8">گروه کارشناسان رهبان با تخصص ویژه در امور حقوقی، بازرگانی، اداری و منابع انسانی، همراهی مطمئن برای پیشبرد اهداف و کاهش ریسک‌های واحدهای صنعتی و تولیدی است.</p>
                <a href="#services" class="bg-accent-color text-white font-bold py-3 px-8 rounded-lg text-lg hover-bg-accent-color transition-colors shadow-lg">آشنایی با خدمات</a>
            </div>
        </section>

        <section id="qararban-cta" class="py-20 bg-gray-100">
            <div class="container mx-auto px-6 text-center">
                <h2 class="text-3xl md:text-4xl font-extrabold mb-4 primary-color">معرفی قراربان: دستیار هوشمند قرارداد شما</h2>
                <p class="text-lg text-gray-600 max-w-3xl mx-auto mb-8">با استفاده از جدیدترین محصول ما، قراردادهای خود را با قدرت هوش مصنوعی تحلیل، تولید و مدیریت کنید. قراربان، محصولی نوآورانه از گروه کارشناسان رهبان.</p>
                <button data-action="open-qararban" class="bg-accent-color text-white font-bold py-3 px-8 rounded-lg text-lg hover-bg-accent-color transition-colors shadow-lg">ورود به پلتفرم قراربان</button>
            </div>
        </section>

        <!-- Services, Calculator, Why Outsource, Process sections go here... -->
        <section id="services" class="py-20 bg-white">
            <div class="container mx-auto px-6">
                <div class="text-center mb-16">
                    <h2 class="text-3xl md:text-4xl font-extrabold mb-3 primary-color">خلاصه خدمات رهبان</h2>
                    <p class="text-gray-600 text-lg">با ارائه بهترین راه حل و تدابیر، یاری‌گر شما هستیم.</p>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-2 gap-8 max-w-5xl mx-auto">
                    <div class="service-card"><div class="flex-grow"><h3 class="text-2xl font-bold mb-4 primary-color">امور حقوقی</h3><ul class="space-y-2 text-gray-600 list-disc list-inside"><li>کارشناسی حقوقی تخصصی (تجارت، کار، تأمین اجتماعی)</li><li>تدوین و تنظیم انواع اسناد حقوقی (قرارداد، صورتجلسه)</li><li>نمایندگی در دعاوی کارگر و کارفرما در اداره کار</li><li>مصالحه و داوری جهت جلوگیری از فرآیند دادرسی</li></ul></div></div>
                    <div class="service-card"><div class="flex-grow"><h3 class="text-2xl font-bold mb-4 primary-color">امور بازرگانی</h3><ul class="space-y-2 text-gray-600 list-disc list-inside"><li>اخذ و تدوین طرح توجیهی و گواهی تولید</li><li>انجام فرآیندهای ثبت سفارش و اظهار گمرکی</li><li>ترخیص کالا با تخصص در مناطق ویژه (مانند سلفچگان)</li><li>بهینه‌سازی هزینه‌ها و بررسی تعرفه کالا (HS Code)</li></ul></div></div>
                    <div class="service-card"><div class="flex-grow"><h3 class="text-2xl font-bold mb-4 primary-color">جذب و استخدام | امور اداری</h3><ul class="space-y-2 text-gray-600 list-disc list-inside"><li>ایجاد پل ارتباطی موثر بین کارفرمایان و نیروهای متخصص</li><li>تأمین نیروی انسانی متعهد و توانمند</li><li>انجام امور بیمه‌ای (تأمین اجتماعی و بیمه تکمیلی مجموعه)</li><li>انجام کلیه امور اداری و پشتیبانی</li></ul></div></div>
                    <div class="service-card"><div class="flex-grow"><h3 class="text-2xl font-bold mb-4 primary-color">حسابرسی، مالیات و امور بانکی</h3><ul class="space-y-2 text-gray-600 list-disc list-inside"><li>همکاری با معتبرترین شرکت‌های حسابرسی استان قم</li><li>کاهش ریسک جرائم مالیاتی و بیمه‌ای</li><li>اخذ ضمانت‌نامه‌های بانکی و اعتبارات اسنادی (LC)</li><li>انجام امور مربوط به حواله‌های ارزی</li></ul></div></div>
                </div>
            </div>
        </section>
        <section id="calculator" class="py-20">
            <div class="container mx-auto px-6">
                <div class="text-center mb-12"><h2 class="text-3xl md:text-4xl font-extrabold mb-3 primary-color">ماشین حساب گمرکی</h2><p class="text-gray-600 text-lg">هزینه های ترخیص کالای خود را به صورت جامع محاسبه کنید.</p></div>
                <div class="max-w-3xl mx-auto bg-white p-8 rounded-2xl shadow-lg border">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div><label for="goods-value" class="block font-semibold mb-2">ارزش کالا (به دلار)</label><input type="text" id="goods-value" inputmode="numeric" class="w-full p-3 border rounded-md focus:ring-2 focus:ring-indigo-300 text-left" dir="ltr" placeholder="e.g., 15000"></div>
                        <div><label for="exchange-rate" class="block font-semibold mb-2">نرخ ارز (به ریال)</label><input type="text" id="exchange-rate" inputmode="numeric" class="w-full p-3 border rounded-md focus:ring-2 focus:ring-indigo-300 text-left" dir="ltr" placeholder="e.g., 420000"></div>
                    </div>
                    <button id="calculate-btn" class="w-full bg-accent-color hover-bg-accent-color text-white font-bold py-3 px-5 rounded-lg mt-6 transition-colors text-lg">محاسبه</button>
                    <div id="result-area" class="mt-8 hidden"><div class="border-t pt-6"><h3 class="text-xl font-bold text-center mb-4 primary-color">جزئیات هزینه‌ها (به ریال)</h3><div class="space-y-3 text-lg"><div class="flex justify-between items-center p-3 bg-gray-50 rounded-md"><span class="font-semibold">ارزش ریالی کالا:</span><span id="result-goods-value-rial" class="font-bold"></span></div><div class="flex justify-between items-center p-3"><span>کرایه:</span><span id="result-freight" class="font-bold"></span></div><div class="flex justify-between items-center p-3 bg-gray-50 rounded-md"><span>بیمه:</span><span id="result-insurance" class="font-bold"></span></div><div class="flex justify-between items-center p-3 font-bold primary-color border-t border-b"><span>ارزش CIF:</span><span id="result-cif"></span></div><div class="flex justify-between items-center p-3"><span>پسماند:</span><span id="result-waste" class="font-bold"></span></div><div class="flex justify-between items-center p-3 bg-gray-50 rounded-md"><span>حقوق ورودی:</span><span id="result-duty" class="font-bold"></span></div><div class="flex justify-between items-center p-3"><span>هلال احمر (۱٪ حقوق ورودی):</span><span id="result-red-crescent" class="font-bold"></span></div><div class="flex justify-between items-center p-3 bg-gray-50 rounded-md"><span>مالیات بر ارزش افزوده:</span><span id="result-vat" class="font-bold"></span></div><div class="flex justify-between items-center p-4 bg-primary-color text-white rounded-lg mt-4 text-xl"><span class="font-bold">جمع کل پرداختی گمرک:</span><span id="result-total" class="font-extrabold"></span></div></div><div class="mt-6 border-t pt-4 text-sm text-gray-500"><h4 class="font-bold mb-2">توضیحات:</h4><ul class="list-disc list-inside space-y-1"><li>مبلغ کرایه در این محاسبه پرداخت نمی‌شود و صرفاً جهت محاسبه هزینه‌های گمرکی (مانند بیمه) استفاده می‌گردد.</li><li>هزینه بیمه شامل مابه‌التفاوت هزینه بیمه باربری می‌باشد.</li></ul></div></div></div>
                </div>
            </div>
        </section>
        <!-- other sections... -->
    </main>
    
    <footer id="contact" class="bg-primary-color text-white mt-12">
        <div class="container mx-auto px-6 py-12 text-center">
            <h2 class="text-2xl font-bold mb-4">گروه کارشناسان رهبان</h2>
            <p class="max-w-xl mx-auto mb-8 text-gray-300">برای دریافت مشاوره و شروع همکاری جهت حفاظت از دارایی‌های کسب‌وکارتان، با ما در تماس باشید.</p>
             <div class="flex flex-col md:flex-row justify-center items-center gap-6 text-lg">
                <a href="mailto:rahban.group.info@gmail.com" class="font-bold">MyRahban@gmail.com</a>
                <span class="hidden md:block">|</span>
                <a href="tel:09128547287" class="font-bold">۰۹۱۲۸۵۴۷۲۸۷</a>
             </div>
             <p class="mt-6 text-gray-400">آدرس: منطقه ویژه اقتصادی سلفچگان - میدان امام خمینی - مجتمع حسینی - پلاک 8</p>
        </div>
    </footer>
    
    <a href="https://forms.gle/cJdyKmKY4Y4HRQHKA" target="_blank" id="fab-google-form" class="hidden fixed bottom-8 right-8 bg-accent-color text-white w-16 h-16 rounded-full flex items-center justify-center text-3xl shadow-lg transform hover:scale-110 transition-transform z-40 opacity-80 hover:opacity-100" title="فرم نظرسنجی/درخواست">📝</a>

    <!-- Qararban Modal (Replaces AI Chat) -->
    <div id="qararban-container" class="hidden fixed inset-0 z-[100] p-4 transition-opacity duration-300 qararban-container">
        <div id="qararban-backdrop" class="absolute inset-0 bg-gray-900/50"></div>
        <div class="relative w-full max-w-6xl mx-auto mt-10 h-[90vh] bg-slate-100 rounded-2xl shadow-2xl flex flex-col overflow-hidden">
            <div class="flex-shrink-0 p-4 border-b bg-white flex justify-between items-center">
                <header class="text-center">
                    <h1 class="text-2xl font-bold primary-color">قراربان</h1>
                    <p class="text-md text-gray-500">پلتفرم جامع مدیریت و تحلیل هوشمند قرارداد</p>
                </header>
                <button id="close-qararban-btn" class="text-gray-400 hover:text-gray-800 text-4xl">&times;</button>
            </div>
            
            <div class="p-4 md:p-8 overflow-y-auto">
                <nav class="flex flex-wrap justify-center bg-slate-200 rounded-t-lg p-2 gap-2">
                    <button data-tab="analyzer" class="tab-button tab-active flex items-center text-base font-semibold py-2 px-4 rounded-md transition-colors duration-300">
                        <ion-icon name="scan-outline" class="ml-2"></ion-icon>تحلیل‌گر
                    </button>
                    <button data-tab="generator" class="tab-button flex items-center text-gray-600 text-base font-semibold py-2 px-4 rounded-md hover:bg-white transition-colors duration-300">
                        <ion-icon name="create-outline" class="ml-2"></ion-icon>مولد قرارداد
                    </button>
                </nav>

                <div id="tab-content" class="bg-white p-6 md:p-8 rounded-b-2xl shadow-lg border border-gray-200 min-h-[60vh]">
                    <!-- Tab 1: Clause Analyzer -->
                    <div id="analyzer-tab-content" class="tab-pane active">
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                            <div>
                                <label for="contract-clause" class="block text-lg font-semibold text-gray-700 mb-2">متن بند قرارداد:</label>
                                <textarea id="contract-clause" rows="10" class="w-full p-4 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-shadow duration-300 resize-y" placeholder="متن مورد نظر برای تحلیل را اینجا وارد کنید..."></textarea>
                                <div class="text-center mt-4">
                                    <button type="button" id="analyze-button" class="w-full bg-accent-color text-white font-bold py-3 px-10 rounded-lg hover-bg-accent-color focus:outline-none focus:ring-4 focus:ring-orange-300 transition-all duration-300">تحلیل کن</button>
                                </div>
                            </div>
                            <div id="analysis-result-container" class="border-r pr-8" aria-live="polite">
                                <div id="analysis-placeholder" class="h-full flex items-center justify-center text-center bg-gray-50 rounded-lg p-8">
                                    <div><ion-icon name="document-text-outline" class="text-5xl text-gray-300 mx-auto"></ion-icon><p class="mt-4 text-gray-500">نتیجه تحلیل شما در اینجا نمایش داده خواهد شد.</p></div>
                                </div>
                                <div id="analysis-loader" class="hidden h-full flex items-center justify-center"><div class="loader"></div></div>
                                <div id="analysis-result" class="hidden prose max-w-none"></div>
                            </div>
                        </div>
                    </div>
                    <!-- Tab 2: Smart Template Generator -->
                    <div id="generator-tab-content" class="tab-pane">
                        <div class="text-center"><h2 class="text-2xl font-bold text-gray-800 mb-2">مولد هوشمند قرارداد</h2><p class="text-gray-500 mb-6">متن گفتگوی واتساپ، صورت‌جلسه یا توافقات شفاهی خود را وارد کنید تا به پیش‌نویس اولیه یک قرارداد تبدیل شود.</p></div>
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                            <div>
                                <label for="conversation-input" class="block text-lg font-semibold text-gray-700 mb-2">متن توافقات:</label>
                                <textarea id="conversation-input" rows="10" class="w-full p-4 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-shadow duration-300 resize-y" placeholder="مثال: سلام، توافق کردیم پروژه طراحی سایت رو با مبلغ ۲۰ میلیون تومان در ۴۵ روز انجام بدم..."></textarea>
                                <div class="text-center mt-4"><button type="button" id="generate-button" class="w-full bg-accent-color text-white font-bold py-3 px-10 rounded-lg hover-bg-accent-color focus:outline-none focus:ring-4 focus:ring-orange-300 transition-all duration-300">تبدیل به قرارداد</button></div>
                            </div>
                            <div id="generator-result-container" class="border-r pr-8" aria-live="polite">
                                <div id="generator-placeholder" class="h-full flex items-center justify-center text-center bg-gray-50 rounded-lg p-8">
                                    <div><ion-icon name="create-outline" class="text-5xl text-gray-300 mx-auto"></ion-icon><p class="mt-4 text-gray-500">پیش‌نویس قرارداد شما اینجا نمایش داده می‌شود.</p></div>
                                </div>
                                <div id="generator-loader" class="hidden h-full flex items-center justify-center"><div class="loader"></div></div>
                                <div id="generator-result" class="hidden prose max-w-none">
                                    <textarea id="generated-contract" readonly class="w-full h-96 p-4 border rounded-lg bg-gray-50 font-mono text-sm"></textarea>
                                    <div class="text-center mt-4"><button type="button" id="copy-btn" class="bg-gray-200 text-gray-800 py-2 px-4 rounded-lg hover:bg-gray-300">کپی متن</button></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- START: CONFIGURATION ---
            const PROXY_ENDPOINT = 'https://complete-faustine-myrahban-ada7be97.koyeb.app/api/generate';
            // --- END: CONFIGURATION ---

            // --- DOM Elements (General) ---
            const menuBtn = document.getElementById('menu-btn');
            const mobileMenu = document.getElementById('mobile-menu');
            const fab = document.getElementById('fab-google-form');

            // --- Hamburger Menu Logic ---
            menuBtn.addEventListener('click', () => {
                mobileMenu.classList.toggle('hidden');
            });

            // --- Qararban Modal Logic ---
            const qararbanContainer = document.getElementById('qararban-container');
            const closeQararbanBtn = document.getElementById('close-qararban-btn');
            const qararbanBackdrop = document.getElementById('qararban-backdrop');
            
            function openQararban() { qararbanContainer.classList.remove('hidden'); }
            function closeQararban() { qararbanContainer.classList.add('hidden'); }

            document.querySelectorAll('[data-action="open-qararban"]').forEach(btn => btn.addEventListener('click', openQararban));
            closeQarbanBtn.addEventListener('click', closeQararban);
            qararbanBackdrop.addEventListener('click', closeQararban);

            // --- Qararban Functionality (from ghararban.html) ---
            const tabButtons = document.querySelectorAll('.tab-button');
            const tabPanes = document.querySelectorAll('.tab-pane');
            const analyzeButton = document.getElementById('analyze-button');
            const clauseInput = document.getElementById('contract-clause');
            const analysisResultContainer = document.getElementById('analysis-result');
            const analysisPlaceholder = document.getElementById('analysis-placeholder');
            const analysisLoader = document.getElementById('analysis-loader');
            const generateButton = document.getElementById('generate-button');
            const conversationInput = document.getElementById('conversation-input');
            const generatorResultContainer = document.getElementById('generator-result');
            const generatorPlaceholder = document.getElementById('generator-placeholder');
            const generatorLoader = document.getElementById('generator-loader');
            const generatedContractTextarea = document.getElementById('generated-contract');
            const copyBtn = document.getElementById('copy-btn');
            const notification = document.getElementById('notification');
            const notificationMessage = document.getElementById('notification-message');
            let notificationTimeout;

            function showNotification(message, type = 'error', duration = 4000) {
                if (notificationTimeout) clearTimeout(notificationTimeout);
                notificationMessage.textContent = message;
                notification.className = 'fixed top-8 right-8 z-[101] p-4 rounded-lg shadow-xl text-white max-w-sm'; // Reset classes
                if (type === 'success') notification.classList.add('bg-green-600');
                else if (type === 'info') notification.classList.add('bg-blue-600');
                else notification.classList.add('bg-red-600');
                notification.classList.add('show');
                notificationTimeout = setTimeout(() => notification.classList.remove('show'), duration);
            }

            tabButtons.forEach(button => {
                button.addEventListener('click', () => {
                    const targetTab = button.dataset.tab;
                    tabButtons.forEach(btn => btn.classList.toggle('tab-active', btn.dataset.tab === targetTab));
                    tabPanes.forEach(pane => pane.classList.toggle('active', pane.id === `${targetTab}-tab-content`));
                });
            });

            function displayError(container, message) {
                container.innerHTML = `<div class="p-4 bg-red-50 border-r-4 border-red-500"><p class="font-bold text-red-800">خطا</p><p class="text-red-700">${message}</p></div>`;
                container.classList.remove('hidden');
            }

            async function callProxy(payload) {
                try {
                    const response = await fetch(PROXY_ENDPOINT, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                    const result = await response.json();
                    if (!response.ok) throw new Error(result.error || 'An unknown error occurred on the proxy server.');
                    if (result.candidates && result.candidates[0]?.content?.parts[0]) return result.candidates[0].content.parts[0].text;
                    else throw new Error("پاسخ معتبری از سرویس دریافت نشد.");
                } catch (error) {
                    console.error("Error calling proxy:", error);
                    throw error;
                }
            }

            analyzeButton.addEventListener('click', async () => {
                const clauseText = clauseInput.value.trim();
                if (!clauseText) { showNotification('لطفاً متنی را برای تحلیل وارد کنید.'); return; }
                
                analysisPlaceholder.classList.add('hidden');
                analysisResultContainer.classList.add('hidden');
                analysisLoader.classList.remove('hidden');

                const prompt = `شما یک وکیل متخصص تحلیل قرارداد در ایران هستید. متن زیر یک بند از یک قرارداد است. لطفاً آن را تحلیل کرده و نتیجه را در قالب یک ساختار JSON ارائه بده. متن بند: "${clauseText}"`;
                const analysisSchema = { type: "OBJECT", properties: { "riskLevel": { "type": "STRING", "enum": ["کم", "متوسط", "بالا"] }, "riskColor": { "type": "STRING", "enum": ["سبز", "زرد", "قرمز"] }, "analysisText": { "type": "STRING" } }, required: ["riskLevel", "riskColor", "analysisText"] };
                const payload = { contents: [{ role: "user", parts: [{ text: prompt }] }], generationConfig: { responseMimeType: "application/json", responseSchema: analysisSchema } };

                try {
                    const resultJsonString = await callProxy(payload);
                    const resultObj = JSON.parse(resultJsonString);
                    displayAnalysis(resultObj);
                } catch (apiError) {
                    showNotification(apiError.message, 'error');
                    displayError(analysisResultContainer, `${apiError.message}`);
                } finally {
                    analysisLoader.classList.add('hidden');
                }
            });

            function displayAnalysis(analysis) {
                const riskColorMap = { "سبز": "green", "زرد": "yellow", "قرمز": "red" };
                const riskColor = riskColorMap[analysis.riskColor] || "gray";
                const formattedText = analysis.analysisText.replace(/\*\*(.*?)\*\*/g, '<h3 class="font-bold text-lg primary-color mt-4 mb-2">$1</h3>').replace(/\* (.*?)(?=\n|\* |$)/g, '<li class="mr-4">$1</li>').replace(/\n/g, '<br>');
                analysisResultContainer.innerHTML = `<div class="space-y-4"><div><h3 class="font-bold text-lg primary-color mb-2">سطح ریسک:</h3><div class="inline-flex items-center px-4 py-1 rounded-full text-base font-bold bg-${riskColor}-100 text-${riskColor}-800 border border-${riskColor}-200">ریسک ${analysis.riskLevel}</div></div><div><ul>${formattedText}</ul></div></div>`;
                analysisResultContainer.classList.remove('hidden');
            }

            generateButton.addEventListener('click', async () => {
                const conversationText = conversationInput.value.trim();
                if (!conversationText) { showNotification('لطفاً متن توافقات را وارد کنید.'); return; }

                generatorPlaceholder.classList.add('hidden');
                generatorResultContainer.classList.add('hidden');
                generatorLoader.classList.remove('hidden');
                
                const prompt = `شما یک دستیار حقوقی هستید که متن گفتگوهای غیررسمی را به پیش‌نویس قرارداد تبدیل می‌کنید. متن زیر توافقات اولیه بین دو نفر است. لطفاً بر اساس آن، یک پیش‌نویس اولیه قرارداد شامل طرفین، موضوع، مبلغ، مدت و تعهدات اصلی به زبان فارسی و با ساختار استاندارد حقوقی تهیه کن. متن گفتگو: "${conversationText}"`;
                const payload = { contents: [{ role: "user", parts: [{ text: prompt }] }] };

                try {
                    const resultText = await callProxy(payload);
                    generatedContractTextarea.value = resultText;
                    generatorResultContainer.classList.remove('hidden');
                } catch (error) {
                    showNotification(error.message, 'error');
                    displayError(generatorResultContainer, `خطا در تولید قرارداد: ${error.message}`);
                } finally {
                    generatorLoader.classList.add('hidden');
                }
            });

            copyBtn.addEventListener('click', () => {
                generatedContractTextarea.select();
                document.execCommand('copy');
                showNotification('متن قرارداد کپی شد!', 'success');
            });

            // --- Customs Calculator Logic (Original) ---
            const calculateBtn = document.getElementById('calculate-btn');
            const goodsValueInput = document.getElementById('goods-value');
            const exchangeRateInput = document.getElementById('exchange-rate');
            const resultArea = document.getElementById('result-area');

            function toEnglishDigits(str) {
                if (typeof str !== 'string') return str;
                return str.replace(/[۰-۹]/g, d => '۰۱۲۳۴۵۶۷۸۹'.indexOf(d)).replace(/[٠-٩]/g, d => '٠١٢٣٤٥٦٧٨٩'.indexOf(d));
            }

            if(calculateBtn) {
                calculateBtn.addEventListener('click', () => {
                    try {
                        const value = parseFloat(toEnglishDigits(goodsValueInput.value || '0').replace(/,/g, ''));
                        const rate = parseFloat(toEnglishDigits(exchangeRateInput.value || '0').replace(/,/g, ''));
                        if (isNaN(value) || isNaN(rate) || value < 0 || rate < 0) { alert('لطفا مقادیر معتبر وارد کنید.'); return; }
                        const goodsValueRial = Math.floor(value * rate);
                        const freight = Math.floor(goodsValueRial * 0.10);
                        const insurance = Math.floor((goodsValueRial + freight) * 0.005);
                        const cif = goodsValueRial + freight + insurance;
                        const waste = Math.floor(cif * 0.0005);
                        const duty = Math.floor(cif * 0.04);
                        const redCrescent = Math.floor(duty * 0.01);
                        const vat = Math.floor((cif + duty) * 0.09);
                        const total = Math.floor(waste + duty + redCrescent + vat);
                        const locale = 'fa-IR';
                        document.getElementById('result-goods-value-rial').textContent = goodsValueRial.toLocaleString(locale);
                        document.getElementById('result-freight').textContent = freight.toLocaleString(locale);
                        document.getElementById('result-insurance').textContent = insurance.toLocaleString(locale);
                        document.getElementById('result-cif').textContent = cif.toLocaleString(locale);
                        document.getElementById('result-waste').textContent = waste.toLocaleString(locale);
                        document.getElementById('result-duty').textContent = duty.toLocaleString(locale);
                        document.getElementById('result-red-crescent').textContent = redCrescent.toLocaleString(locale);
                        document.getElementById('result-vat').textContent = vat.toLocaleString(locale);
                        document.getElementById('result-total').textContent = total.toLocaleString(locale);
                        resultArea.classList.remove('hidden');
                    } catch (error) {
                        console.error("Calculator error:", error);
                        alert('خطایی در محاسبه رخ داد. لطفا ورودی خود را بررسی کنید.');
                    }
                });
            }

            // --- Floating Action Button (FAB) Logic ---
            window.addEventListener('scroll', () => {
                if (window.scrollY > 200) fab.classList.remove('hidden');
                else fab.classList.add('hidden');
            });
        });
    </script>
</body>
</html>
